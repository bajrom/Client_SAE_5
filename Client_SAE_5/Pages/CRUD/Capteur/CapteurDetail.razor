@page "/crud/capteurs/{idCapteur:int}"
@inject Client_SAE_5.ViewModel.CapteurViewModel CapteurViewModel
@inject NavigationManager NavigationManager

<PageTitle>Détail du Capteur</PageTitle>

<h1>Détail du Capteur</h1>

<span id="mainContainer" style="display:flex;flex-direction:row;justify-content:space-between;">
@if (CapteurViewModel.SelectedCapteurDetail == null)
{
    <Spinner></Spinner>
}
else
{
    <div>
        <h2>Informations générales</h2>
        <p><strong>Nom :</strong> @CapteurViewModel.SelectedCapteurDetail.NomCapteur</p>
        <p><strong>Etat:</strong> @(Utils.Utils.RenderEtatContent(CapteurViewModel.SelectedCapteurDetail.EstActif))</p>

        <br />
        <h3>Localisation</h3>
            <h5 class="murInfo">
                Salle:
            <a href="/crud/salles/@(CapteurViewModel.SelectedCapteurDetail.Salle.IdSalle)">@(CapteurViewModel.SelectedCapteurDetail.Salle.NomSalle)</a>
        </h5>
        <h5 class="murInfo">Mur:
        @if (CapteurViewModel.SelectedCapteurDetail.Mur != null)
        {
            <a href="/crud/murs/@(CapteurViewModel.SelectedCapteurDetail.Mur.IdMur)">
                <p> @(Math.Round(CapteurViewModel.SelectedCapteurDetail.Mur.Orientation, 2))°</p>
            </a>
        }
        else
        {
            <p><em>Pas de mur associé.</em></p>
        }
        </h5>

        <br />
        <h3>Unités</h3>
        @if (CapteurViewModel.SelectedCapteurDetail.Unites?.Count > 0)
        {
            <ul>
                @foreach (var unite in CapteurViewModel.SelectedCapteurDetail.Unites)
                {
                    <li>
                        @unite.NomUnite
                        <button class="btn btn-danger btn-sm"
                                @onclick="() => SupprimerUniteCapteur(unite.IdUnite, CapteurViewModel.SelectedCapteurDetail.IdCapteur)">
                                <Icon Name="IconName.Trash3Fill"></Icon>
                        </button>
                    </li>
                }
            </ul>
        }
        else
        {
            <p><em>Aucune unité associée.</em></p>
        }
    </div>

    @if (CapteurViewModel.SelectedCapteurDetail.Mur == null || CapteurViewModel.SelectedCapteurDetail == null)
    {
        <p><em>Aucun détail disponible pour la position de ce capteur.</em></p>
    }
    else
    {
        <span>
            <h1>Position du capteur sur le mur</h1>
            <div id="cadreMur" style="position: relative; width: @(MurLargeurPx + "px"); height: @(MurHauteurPx + "px"); border: 1px solid black;">
                <div style="position: absolute; width: 10px; height: 10px; background-color: red; border-radius: 50%; @GetCapteurPositionStyle(CapteurViewModel.SelectedCapteurDetail)"
                        title="Positions: (@CapteurViewModel.SelectedCapteurDetail.XCapteur cm; @CapteurViewModel.SelectedCapteurDetail.YCapteur cm; @CapteurViewModel.SelectedCapteurDetail.ZCapteur cm)">
                </div>
            </div>
            <p>
                <strong>Coordonnées (<em>À partir d'en haut à gauche</em>)</strong> (X:@(CapteurViewModel.SelectedCapteurDetail.XCapteur/100)m;
                                                                                     Y:@(CapteurViewModel.SelectedCapteurDetail.YCapteur/100)m)
            </p> 
        </span>
            
    }
    
    
}
</span>
<button class="btn btn-secondary" @onclick="Retour">Retour</button>
@if (!string.IsNullOrEmpty(CapteurViewModel.ErrorMessage))
{
    <div class="alert alert-danger">
        @CapteurViewModel.ErrorMessage
    </div>
}

<style>
    .murInfo{
        display:flex;
    }
</style>

@code {
    [Parameter]
    public int IdCapteur { get; set; }

    // Dimensions du mur en cm (valeurs récupérées depuis le ViewModel ou DTO)
    private decimal MurLongueurCm => CapteurViewModel.SelectedCapteurDetail.Mur.Longueur; // Exemple : 600 cm
    private decimal MurHauteurCm => CapteurViewModel.SelectedCapteurDetail.Mur.Hauteur;  // Exemple : 300 cm

    // Dimensions du mur affiché en pixels
    private const int MurLargeurPx = 600; // Largeur en pixels (à ajuster selon l'interface)
    private const int MurHauteurPx = 300; // Hauteur en pixels (à ajuster selon l'interface)

    // Échelle pour convertir cm -> pixels
    private decimal ScaleX => MurLargeurPx / MurLongueurCm; // Pixels par cm en largeur
    private decimal ScaleY => MurHauteurPx / MurHauteurCm; // Pixels par cm en hauteur

    private string GetCapteurPositionStyle(CapteurDetailDTO capteur)
    {
        if (CapteurViewModel.SelectedCapteurDetail.Mur == null) return "";

        // Convertir les coordonnées en pixels
        decimal leftPx = capteur.XCapteur * ScaleX;
        decimal topPx = capteur.YCapteur * ScaleY;

        // Retourner le style CSS avec les positions normalisées
        return $"left: {leftPx.ToString(System.Globalization.CultureInfo.InvariantCulture)}px; " +
               $"top: {topPx.ToString(System.Globalization.CultureInfo.InvariantCulture)}px;";
    }


    protected override async Task OnInitializedAsync()
    {
        await CapteurViewModel.LoadCapteurDetailsAsync(IdCapteur);
    }

    private async Task SupprimerUniteCapteur(int idUnite, int idCapteur)
    {
        await CapteurViewModel.DeleteUniteCapteurAsync(idUnite, idCapteur);
        StateHasChanged();
    }

    private void Retour()
    {
        NavigationManager.NavigateTo("/crud/capteurs");
    }
}
